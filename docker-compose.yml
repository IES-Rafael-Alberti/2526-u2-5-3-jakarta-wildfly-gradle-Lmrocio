services:
  # Servicio de Aplicación (Backend)
  wildfly:
    image: quay.io/wildfly/wildfly:latest
    container_name: wildfly_backend
    command: /opt/jboss/wildfly/bin/standalone.sh -b 0.0.0.0
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
    volumes:
      # Despliegue automático del WAR al arrancar
      - ./build/libs/crud-file.war:/opt/jboss/wildfly/standalone/deployments/crud-file.war
      # Persistencia de logs en carpeta local
      - ./logs/wildfly:/opt/jboss/wildfly/standalone/log
    networks:
      - app-network
    healthcheck:
      # Comprueba que el servidor responde internamente antes de darlo por válido
      test: ["CMD", "curl", "-f", "http://localhost:8080/crud-file"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Servicio Web / Proxy (Frontend)
  nginx:
    image: nginx:alpine
    container_name: nginx_proxy
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      wildfly:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

# Red interna para que se vean entre ellos
networks:
  app-network:
    driver: bridge
